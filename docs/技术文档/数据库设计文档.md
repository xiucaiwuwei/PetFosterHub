# PetFosterHub 数据库设计文档

## 1. 概述

本文档详细描述了PetFosterHub系统的数据库设计，包括数据库表结构、关系设计、索引设计、数据安全等内容，为系统的数据存储提供详细指导，也为毕业设计论文提供数据库实现的详细说明。

## 2. 数据库选型

系统采用以下数据库技术：

- **主数据库**：MySQL 8.0
  - 关系型数据库，适合存储结构化数据
  - 支持事务处理，保证数据一致性
  - 性能稳定，易于维护
  - 社区活跃，文档完善

- **缓存**：Redis 6.0
  - 高性能键值存储
  - 支持多种数据结构
  - 提供持久化机制
  - 用于缓存热点数据，提高系统性能

## 3. 数据库表结构设计

### 3.1 用户表（users）

**功能**：存储系统用户的基本信息

```sql
CREATE TABLE users (
  user_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password VARCHAR(100) NOT NULL COMMENT '密码（加密存储）',
  email VARCHAR(100) UNIQUE COMMENT '邮箱',
  phone VARCHAR(20) UNIQUE COMMENT '手机号码',
  role VARCHAR(20) NOT NULL COMMENT '角色（OWNER：宠物主人，FOSTER：寄养家庭，ADMIN：管理员）',
  avatar VARCHAR(255) COMMENT '头像URL',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '状态（1：正常，0：禁用）'
) COMMENT='用户信息表';
```

### 3.2 宠物表（pets）

**功能**：存储宠物的详细信息

```sql
CREATE TABLE pets (
  pet_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '宠物ID',
  owner_id BIGINT NOT NULL COMMENT '主人ID',
  name VARCHAR(50) NOT NULL COMMENT '宠物名称',
  type VARCHAR(30) NOT NULL COMMENT '宠物类型（狗、猫等）',
  breed VARCHAR(50) COMMENT '宠物品种',
  age INT COMMENT '年龄（岁）',
  gender VARCHAR(10) COMMENT '性别（MALE：公，FEMALE：母）',
  weight DOUBLE COMMENT '体重（kg）',
  description TEXT COMMENT '宠物描述',
  health_status VARCHAR(50) COMMENT '健康状况',
  special_needs TEXT COMMENT '特殊需求',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (owner_id) REFERENCES users (user_id) ON DELETE CASCADE
) COMMENT='宠物信息表';
```

### 3.3 寄养服务表（foster_services）

**功能**：存储寄养家庭提供的寄养服务信息

```sql
CREATE TABLE foster_services (
  service_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '服务ID',
  foster_id BIGINT NOT NULL COMMENT '寄养家庭ID',
  title VARCHAR(100) NOT NULL COMMENT '服务标题',
  description TEXT NOT NULL COMMENT '服务描述',
  price DECIMAL(10, 2) NOT NULL COMMENT '服务价格（每天）',
  location VARCHAR(100) NOT NULL COMMENT '服务地点',
  available_start_time DATETIME NOT NULL COMMENT '可提供服务开始时间',
  available_end_time DATETIME NOT NULL COMMENT '可提供服务结束时间',
  capacity INT NOT NULL COMMENT '可容纳宠物数量',
  pet_types VARCHAR(255) NOT NULL COMMENT '可接受宠物类型（逗号分隔）',
  status VARCHAR(20) NOT NULL DEFAULT 'AVAILABLE' COMMENT '服务状态（AVAILABLE：可预订，BOOKED：已预订，CLOSED：已关闭）',
  rating DOUBLE NOT NULL DEFAULT 0 COMMENT '服务评分',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (foster_id) REFERENCES users (user_id) ON DELETE CASCADE
) COMMENT='寄养服务信息表';
```

### 3.4 订单表（bookings）

**功能**：存储用户预约寄养服务的订单信息

```sql
CREATE TABLE bookings (
  booking_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '订单ID',
  service_id BIGINT NOT NULL COMMENT '服务ID',
  owner_id BIGINT NOT NULL COMMENT '宠物主人ID',
  pet_id BIGINT NOT NULL COMMENT '宠物ID',
  start_time DATETIME NOT NULL COMMENT '寄养开始时间',
  end_time DATETIME NOT NULL COMMENT '寄养结束时间',
  total_price DECIMAL(10, 2) NOT NULL COMMENT '订单总价',
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '订单状态（PENDING：待确认，CONFIRMED：已确认，PAID：已支付，COMPLETED：已完成，CANCELLED：已取消）',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (service_id) REFERENCES foster_services (service_id) ON DELETE CASCADE,
  FOREIGN KEY (owner_id) REFERENCES users (user_id) ON DELETE CASCADE,
  FOREIGN KEY (pet_id) REFERENCES pets (pet_id) ON DELETE CASCADE
) COMMENT='预约信息表';
```

### 3.5 支付表（payments）

**功能**：存储订单支付相关信息

```sql
CREATE TABLE payments (
  payment_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '支付ID',
  booking_id BIGINT NOT NULL UNIQUE COMMENT '订单ID',
  amount DECIMAL(10, 2) NOT NULL COMMENT '支付金额',
  payment_method VARCHAR(30) NOT NULL COMMENT '支付方式',
  transaction_id VARCHAR(100) NOT NULL COMMENT '交易流水号',
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '支付状态（PENDING：待支付，SUCCESS：支付成功，FAILED：支付失败，REFUNDED：已退款）',
  payment_time DATETIME COMMENT '支付时间',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (booking_id) REFERENCES bookings (booking_id) ON DELETE CASCADE
) COMMENT='支付信息表';
```

### 3.6 评价表（reviews）

**功能**：存储用户对寄养服务的评价信息

```sql
CREATE TABLE reviews (
  review_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '评价ID',
  booking_id BIGINT NOT NULL UNIQUE COMMENT '订单ID',
  service_id BIGINT NOT NULL COMMENT '服务ID',
  reviewer_id BIGINT NOT NULL COMMENT '评价人ID',
  target_id BIGINT NOT NULL COMMENT '被评价人ID',
  rating INT NOT NULL COMMENT '评分（1-5星）',
  comment TEXT COMMENT '评价内容',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (booking_id) REFERENCES bookings (booking_id) ON DELETE CASCADE,
  FOREIGN KEY (service_id) REFERENCES foster_services (service_id) ON DELETE CASCADE,
  FOREIGN KEY (reviewer_id) REFERENCES users (user_id) ON DELETE CASCADE,
  FOREIGN KEY (target_id) REFERENCES users (user_id) ON DELETE CASCADE
) COMMENT='评价信息表';
```

### 3.7 消息表（messages）

**功能**：存储用户之间的消息交流记录

```sql
CREATE TABLE messages (
  message_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '消息ID',
  sender_id BIGINT NOT NULL COMMENT '发送方ID',
  receiver_id BIGINT NOT NULL COMMENT '接收方ID',
  booking_id BIGINT COMMENT '关联订单ID',
  content TEXT NOT NULL COMMENT '消息内容',
  is_read TINYINT NOT NULL DEFAULT 0 COMMENT '是否已读（0：未读，1：已读）',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
  FOREIGN KEY (sender_id) REFERENCES users (user_id) ON DELETE CASCADE,
  FOREIGN KEY (receiver_id) REFERENCES users (user_id) ON DELETE CASCADE,
  FOREIGN KEY (booking_id) REFERENCES bookings (booking_id) ON DELETE CASCADE
) COMMENT='消息信息表';
```

### 3.8 文件上传表（file_uploads）

**功能**：存储系统中上传的文件信息

```sql
CREATE TABLE file_uploads (
  file_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '文件ID',
  user_id BIGINT NOT NULL COMMENT '上传用户ID',
  file_name VARCHAR(255) NOT NULL COMMENT '文件名称',
  file_path VARCHAR(255) NOT NULL COMMENT '文件存储路径',
  file_size BIGINT NOT NULL COMMENT '文件大小（字节）',
  file_type VARCHAR(50) NOT NULL COMMENT '文件类型',
  related_id BIGINT COMMENT '关联业务ID',
  related_type VARCHAR(50) COMMENT '关联业务类型',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE
) COMMENT='文件上传信息表';
```

### 3.9 审计日志表（audit_log）

**功能**：记录系统的关键操作日志，用于安全审计和问题追踪

```sql
CREATE TABLE audit_log (
  log_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
  user_id BIGINT COMMENT '操作用户ID',
  username VARCHAR(50) COMMENT '操作用户名',
  operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
  operation_desc VARCHAR(255) COMMENT '操作描述',
  resource_type VARCHAR(50) COMMENT '资源类型',
  resource_id VARCHAR(100) COMMENT '资源ID',
  ip_address VARCHAR(50) COMMENT 'IP地址',
  user_agent VARCHAR(255) COMMENT '用户代理',
  request_params TEXT COMMENT '请求参数',
  response_result TEXT COMMENT '响应结果',
  operation_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '操作状态（1：成功，0：失败）',
  error_message TEXT COMMENT '错误信息'
) COMMENT='审计日志表';
```

## 4. 数据库关系图

```
+-------------+     +------------+     +-------------------+
|    users    |1---N|    pets    |1---N|     bookings      |
+-------------+     +------------+     +-------------------+
       |                    |                    |
       |                    |                    |
       |1                  N|                    |N
       |                    |                    |
+-------------+     +-------------------+     +------------+
|    users    |1---N| foster_services   |1---N|  payments  |
+-------------+     +-------------------+     +------------+
       |                      |
       |                      |
       |N                     |N
       |                      |
+-------------+     +-------------------+
|   messages  |     |     reviews       |
+-------------+     +-------------------+
       |                      |
       |                      |
       |1                     |N
       |                      |
+-------------+     +-------------------+
| file_uploads|     |    audit_log      |
+-------------+     +-------------------+
```

## 5. 索引设计

为提高数据库查询性能，对以下字段创建索引：

1. **users表**：
   - `username`：唯一索引，用于登录认证
   - `email`：唯一索引，用于邮箱验证和找回密码
   - `phone`：唯一索引，用于手机验证

2. **pets表**：
   - `owner_id`：普通索引，用于查询用户的所有宠物
   - `type`：普通索引，用于按宠物类型搜索

3. **foster_services表**：
   - `foster_id`：普通索引，用于查询寄养家庭的所有服务
   - `location`：普通索引，用于按位置搜索服务
   - `available_start_time`和`available_end_time`：复合索引，用于按时间搜索可预约服务
   - `status`：普通索引，用于查询特定状态的服务

4. **bookings表**：
   - `service_id`：普通索引，用于查询服务的所有订单
   - `owner_id`：普通索引，用于查询宠物主人的所有订单
   - `pet_id`：普通索引，用于查询宠物的所有订单
   - `status`：普通索引，用于查询特定状态的订单
   - `start_time`和`end_time`：复合索引，用于按时间范围查询订单

5. **payments表**：
   - `booking_id`：唯一索引，用于关联订单
   - `transaction_id`：唯一索引，用于查询交易记录
   - `status`：普通索引，用于查询特定状态的支付记录

6. **reviews表**：
   - `booking_id`：唯一索引，用于关联订单
   - `service_id`：普通索引，用于查询服务的所有评价
   - `reviewer_id`：普通索引，用于查询用户的评价历史
   - `target_id`：普通索引，用于查询用户收到的评价

7. **messages表**：
   - `sender_id`和`receiver_id`：复合索引，用于查询用户之间的消息
   - `booking_id`：普通索引，用于查询订单相关消息
   - `is_read`：普通索引，用于查询未读消息

8. **file_uploads表**：
   - `user_id`：普通索引，用于查询用户上传的文件
   - `related_id`和`related_type`：复合索引，用于查询业务相关文件

## 6. 数据安全设计

### 6.1 数据加密

- **密码加密**：用户密码使用BCrypt算法加密存储
- **敏感信息**：信用卡号等敏感信息进行加密存储或脱敏处理
- **传输加密**：数据库连接使用SSL加密，防止数据在传输过程中被窃取

### 6.2 访问控制

- **最小权限原则**：数据库用户只拥有完成其工作所需的最小权限
- **角色分离**：区分读写权限、管理权限等，避免权限过大
- **定期审计**：定期审计数据库访问日志，发现异常访问行为

### 6.3 数据备份与恢复

- **定期备份**：制定完善的数据备份策略，包括全量备份和增量备份
- **备份验证**：定期验证备份数据的可用性和完整性
- **恢复演练**：定期进行数据恢复演练，确保在灾难发生时能够快速恢复数据

## 7. 性能优化

### 7.1 查询优化

- **合理使用索引**：根据查询需求创建适当的索引，避免过度索引
- **优化查询语句**：避免全表扫描，使用JOIN代替子查询等
- **分页查询**：对大数据量查询使用分页，减少单次查询的数据量

### 7.2 缓存策略

- **引入Redis缓存**：将热点数据缓存到Redis中，减少数据库访问压力
- **多级缓存**：实现本地缓存+Redis缓存的多级缓存架构
- **缓存失效策略**：合理设置缓存过期时间，避免缓存雪崩

### 7.3 分库分表策略（预留）

- **垂直分库**：将不同业务模块的数据分散到不同的数据库
- **水平分表**：对于数据量较大的表，考虑按时间或ID进行水平分表

## 8. 数据库维护

- **定期检查**：定期检查数据库运行状态、存储空间、索引使用情况等
- **性能调优**：根据监控数据，对数据库进行性能调优
- **日志管理**：合理设置数据库日志级别，定期清理日志文件
- **版本升级**：定期进行数据库版本升级，获取新功能和性能改进

## 9. 附录：初始化脚本

系统数据库初始化脚本存放在项目的`backend/src/main/resources/db/`目录下：
- `schema.sql`：包含数据库表结构定义
- `data.sql`：包含初始数据（如管理员用户、基础配置等）